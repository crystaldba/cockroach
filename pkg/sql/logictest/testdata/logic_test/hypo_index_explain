# Tests for the hypo_index_explain built-in function

statement ok
CREATE TABLE test_table (a INT, b INT, c INT)

statement ok
INSERT INTO test_table VALUES (1, 10, 100), (2, 20, 200), (3, 30, 300)

# Basic functionality with simple query and one index
query T
SELECT hypo_index_explain('SELECT * FROM test_table WHERE a = 1', ARRAY['CREATE INDEX idx_a ON test_table (a)'])
----
# EXPLAIN with hypothetical indexes:
# Hypothetical indexes used:
# 1: CREATE INDEX ON test_table (a)

scan test_table
 └── constraint: /a/=1

# Test with multiple indexes
query T
SELECT hypo_index_explain(
  'SELECT * FROM test_table WHERE a = 1 AND b = 2',
  ARRAY[
    'CREATE INDEX idx_a ON test_table (a)',
    'CREATE INDEX idx_b ON test_table (b)',
    'CREATE INDEX idx_ab ON test_table (a, b)'
  ]
)
----
# EXPLAIN with hypothetical indexes:
# Hypothetical indexes used:
# 1: CREATE INDEX ON test_table (a)
# 2: CREATE INDEX ON test_table (b)
# 3: CREATE INDEX ON test_table (a, b)

scan test_table
 └── constraint: /a/=1/b/=2

# Test with EXPLAIN options
query T
SELECT hypo_index_explain(
  'SELECT * FROM test_table WHERE a = 1',
  ARRAY['CREATE INDEX idx_a ON test_table (a)'],
  'VERBOSE'
)
----
# EXPLAIN with hypothetical indexes:
# Hypothetical indexes used:
# 1: CREATE INDEX ON test_table (a)

scan test_table
 ├── columns: a:1(int) b:2(int) c:3(int)
 └── constraint: /a/=1

# Error cases

# Invalid query
statement error failed to parse query
SELECT hypo_index_explain('SELECT * FROM', ARRAY['CREATE INDEX idx_a ON test_table (a)'])

# Empty index array
statement error at least one valid CREATE INDEX statement must be provided
SELECT hypo_index_explain('SELECT * FROM test_table', ARRAY[]::STRING[])

# Invalid index statement
statement error failed to parse CREATE INDEX statement
SELECT hypo_index_explain('SELECT * FROM test_table', ARRAY['CREATE INDX idx_a ON test_table (a)'])

# Non-CREATE INDEX statement
statement error statement at position 1 is not a CREATE INDEX statement
SELECT hypo_index_explain('SELECT * FROM test_table', ARRAY['SELECT * FROM test_table'])

# Multiple statements in the query
statement error query must contain exactly one SQL statement
SELECT hypo_index_explain('SELECT * FROM test_table; SELECT 1', ARRAY['CREATE INDEX idx_a ON test_table (a)'])

# Column doesn't exist
statement error column "d" not found
SELECT hypo_index_explain('SELECT * FROM test_table WHERE a = 1', ARRAY['CREATE INDEX idx_d ON test_table (d)'])

# Table doesn't exist
statement error failed to resolve table
SELECT hypo_index_explain('SELECT * FROM test_table WHERE a = 1', ARRAY['CREATE INDEX idx_a ON nonexistent_table (a)']) 
